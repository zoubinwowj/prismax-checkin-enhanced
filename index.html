<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prismaxæ‰¹é‡ç­¾åˆ°å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .log-container {
            margin-top: 20px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-success {
            color: #4CAF50;
        }
        .log-error {
            color: #f44336;
        }
        .log-info {
            color: #2196F3;
        }
        .stats {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 5px;
        }
        .proxy-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        .proxy-input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        label {
            display: inline-block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ Prismaxæ‰¹é‡ç­¾åˆ°å·¥å…·ï¼ˆä¿®å¤ç‰ˆï¼‰</h1>
        
        <div>
            <label for="wallets">é’±åŒ…åœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
            <textarea id="wallets" placeholder="è¾“å…¥é’±åŒ…åœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª..."></textarea>
        </div>
        
        <div class="proxy-section">
            <h3>ä»£ç†è®¾ç½®</h3>
            <label>
                <input type="checkbox" id="useProxy"> ä½¿ç”¨ä»£ç†
            </label>
            <input type="text" id="proxyUrl" class="proxy-input" placeholder="http://ip:port æˆ– socks5://ip:port">
        </div>
        
        <button id="startBtn" onclick="startBatchCheckin()">å¼€å§‹æ‰¹é‡ç­¾åˆ°</button>
        <button id="clearBtn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        
        <div class="stats" id="stats" style="display:none;">
            <div>æ€»é’±åŒ…æ•°ï¼š<span id="totalWallets">0</span></div>
            <div>æˆåŠŸï¼š<span id="successCount">0</span></div>
            <div>å¤±è´¥ï¼š<span id="failCount">0</span></div>
            <div>å·²ç­¾åˆ°ï¼š<span id="alreadyCheckedCount">0</span></div>
            <div>æ€»ç§¯åˆ†ï¼š<span id="totalPoints">0</span></div>
        </div>
        
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        let isRunning = false;
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
        }
        
        function parseWallets(text) {
            // æ¸…ç†å’Œè§£æé’±åŒ…åœ°å€
            return text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0 && line.length > 20); // åŸºæœ¬éªŒè¯
        }
        
        async function startBatchCheckin() {
            if (isRunning) {
                log('ç­¾åˆ°ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...', 'error');
                return;
            }
            
            const walletsText = document.getElementById('wallets').value;
            const wallets = parseWallets(walletsText);
            
            if (wallets.length === 0) {
                log('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªé’±åŒ…åœ°å€', 'error');
                return;
            }
            
            // éªŒè¯é’±åŒ…åœ°å€æ ¼å¼
            const invalidWallets = wallets.filter(w => w.length < 32 || w.length > 50);
            if (invalidWallets.length > 0) {
                log(`å‘ç° ${invalidWallets.length} ä¸ªæ— æ•ˆé’±åŒ…åœ°å€æ ¼å¼`, 'error');
                invalidWallets.forEach(w => log(`æ— æ•ˆåœ°å€: ${w}`, 'error'));
                return;
            }
            
            isRunning = true;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'ç­¾åˆ°è¿›è¡Œä¸­...';
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            document.getElementById('stats').style.display = 'block';
            document.getElementById('totalWallets').textContent = wallets.length;
            
            const options = {
                useProxy: document.getElementById('useProxy').checked,
                proxy: document.getElementById('proxyUrl').value
            };
            
            log(`å¼€å§‹æ‰¹é‡ç­¾åˆ°ï¼Œå…± ${wallets.length} ä¸ªé’±åŒ…`, 'info');
            
            try {
                const response = await fetch('/api/batch-checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        wallets: wallets,
                        options: options
                    })
                });
                
                // é¦–å…ˆæ£€æŸ¥å“åº”æ˜¯å¦ä¸ºJSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // å°è¯•è·å–æ–‡æœ¬å“åº”ä»¥ä¾¿è°ƒè¯•
                    const text = await response.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›éJSONå“åº”: ${text.substring(0, 100)}...`);
                }
                
                // å°è¯•è§£æJSON
                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    // å¦‚æœJSONè§£æå¤±è´¥ï¼Œè·å–åŸå§‹æ–‡æœ¬
                    const text = await response.text();
                    log(`JSONè§£æå¤±è´¥ï¼ŒåŸå§‹å“åº”: ${text.substring(0, 200)}...`, 'error');
                    throw new Error('æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯');
                }
                
                if (data.success) {
                    processResults(data.results);
                } else {
                    throw new Error(data.error || data.message || 'æœªçŸ¥é”™è¯¯');
                }
                
            } catch (error) {
                log(`æ‰¹é‡ç­¾åˆ°å¤±è´¥: ${error.message}`, 'error');
                
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´å¤šä¿¡æ¯
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    log('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä»£ç†è®¾ç½®', 'error');
                }
            } finally {
                isRunning = false;
                startBtn.disabled = false;
                startBtn.textContent = 'å¼€å§‹æ‰¹é‡ç­¾åˆ°';
            }
        }
        
        function processResults(results) {
            let successCount = 0;
            let failCount = 0;
            let alreadyCheckedCount = 0;
            let totalPoints = 0;
            
            results.forEach(result => {
                if (result.success) {
                    if (result.alreadyChecked) {
                        alreadyCheckedCount++;
                        log(`é’±åŒ… ${result.wallet.substring(0, 10)}... ä»Šæ—¥å·²ç­¾åˆ°`, 'info');
                    } else {
                        successCount++;
                        totalPoints += result.points || 0;
                        log(`é’±åŒ… ${result.wallet.substring(0, 10)}... ç­¾åˆ°æˆåŠŸï¼Œè·å¾— ${result.points} ç§¯åˆ†`, 'success');
                    }
                } else {
                    failCount++;
                    log(`é’±åŒ… ${result.wallet.substring(0, 10)}... ç­¾åˆ°å¤±è´¥: ${result.error}`, 'error');
                }
            });
            
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('alreadyCheckedCount').textContent = alreadyCheckedCount;
            document.getElementById('totalPoints').textContent = totalPoints;
            
            const successRate = ((successCount + alreadyCheckedCount) / results.length * 100).toFixed(1);
            log(`ğŸ‰ æ‰¹é‡ç­¾åˆ°å®Œæˆï¼æˆåŠŸç‡${successRate}%ï¼Œå…±è·å¾— ${totalPoints} ç§¯åˆ†`, 'success');
        }
        
        // åŠ è½½ä¿å­˜çš„é’±åŒ…åœ°å€
        window.onload = function() {
            const savedWallets = localStorage.getItem('wallets');
            if (savedWallets) {
                document.getElementById('wallets').value = savedWallets;
            }
            
            log('ğŸŒ Prismaxæ‰¹é‡ç­¾åˆ°å·¥å…·ï¼ˆä¿®å¤ç‰ˆï¼‰å·²å¯åŠ¨', 'info');
            log('æ”¯æŒæ‰¹é‡ç­¾åˆ°ï¼Œå·²ä¿®å¤JSONè§£æé”™è¯¯', 'info');
        };
        
        // ä¿å­˜é’±åŒ…åœ°å€
        document.getElementById('wallets').addEventListener('change', function() {
            localStorage.setItem('wallets', this.value);
        });
    </script>
</body>
</html>